<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SRMS – Smart Restaurant (SPA)</title>

    <style>
        :root {
            --primary: #1b2a41;
            --accent: #2196f3;
            --accent-soft: #e3f2fd;
            --success: #4caf50;
            --danger: #e53935;
            --bg: #f2f4f8;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: #222;
        }
        header {
            background: linear-gradient(135deg, #1b2a41, #122033);
            padding: 14px 20px 10px 20px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .logo {
            font-size: 22px;
            font-weight: bold;
        }
        .logo span {
            color: #ffc107;
        }
        .status-pill {
            font-size: 12px;
            background: rgba(255,255,255,0.12);
            padding: 4px 10px;
            border-radius: 999px;
        }
        .role-tabs {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .role-tabs button {
            padding: 7px 14px;
            border-radius: 999px;
            border: none;
            background: rgba(255,255,255,0.12);
            color: white;
            cursor: pointer;
            font-size: 13px;
        }
        .role-tabs button.active-role {
            background: #ffc107;
            color: #122033;
            font-weight: bold;
        }
        main {
            padding: 20px;
            max-width: 1100px;
            margin: 0 auto;
        }
        .panel { display: none; }
        .panel.active { display: block; }
        h2 { margin-top: 0; }

        /* Customer subnav */
        .subnav {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .subnav button {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }
        .subnav button.active-sub {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Menu grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 18px;
            margin-top: 12px;
        }
        .menu-card {
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .menu-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .menu-card-body {
            padding: 10px 12px 12px 12px;
        }
        .menu-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
        }
        .badge {
            background: var(--accent-soft);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
        }
        .menu-card p {
            margin: 6px 0 0 0;
            font-size: 13px;
            color: #555;
        }
        .menu-card button {
            width: 100%;
            padding: 9px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Generic card and tables */
        .card {
            background: white;
            padding: 16px;
            border-radius: 14px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
            margin-bottom: 18px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border-bottom: 1px solid #eee;
            padding: 6px 8px;
            text-align: left;
        }
        th {
            background: #fafafa;
        }
        input, select, textarea {
            font-size: 13px;
        }

        .primary-btn {
            background: var(--accent);
            border-radius: 999px;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
        }
        .primary-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        .danger-btn {
            background: var(--danger);
            border-radius: 999px;
            border: none;
            color: white;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #eee;
        }
        .status-pill {
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 11px;
            display: inline-block;
        }
        .status-RECEIVED { background: #e3f2fd; color: #0d47a1; }
        .status-PREPARING { background: #fff3cd; color: #8a6d3b; }
        .status-READY { background: #e8f5e9; color: #2e7d32; }
        .status-OUT_FOR_DELIVERY { background: #e3f2fd; color: #01579b; }
        .status-COMPLETED { background: #e0f2f1; color: #004d40; }
        .status-CANCELLED { background: #ffebee; color: #b71c1c; }

        /* Layout helpers */
        .flex-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .flex-2 {
            flex: 2 1 250px;
        }
        .flex-1 {
            flex: 1 1 200px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #323232;
            color: white;
            padding: 10px 16px;
            border-radius: 999px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
            transform: translateY(10px);
            z-index: 999;
        }
        .toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .tagline {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
        }
        .small-label {
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>

<header>
    <div class="top-bar">
        <div class="logo">
            SRMS <span>Smart Restaurant</span>
        </div>
        <div class="status-pill" id="healthStatus">
            Backend: checking...
        </div>
        <div class="status-pill" id="userStatus">
            Role: Customer (public)
        </div>
    </div>

    <div class="role-tabs">
        <button class="active-role" onclick="switchRole('customer', this)">Customer</button>
        <button onclick="switchRole('admin', this)">Admin</button>
        <button onclick="switchRole('waiter', this)">Waiter</button>
        <button onclick="switchRole('kitchen', this)">Kitchen</button>
        <button onclick="toggleLogin()">Login</button>
    </div>
</header>

<main>
    <!-- CUSTOMER PANEL -->
    <section id="panel-customer" class="panel active">
        <h2>Customer Portal</h2>
        <p class="tagline">
            Browse the menu, choose your order type, place an order, and track its status.
        </p>

        <div class="subnav">
            <button class="active-sub" onclick="showCustomerSection('cust-menu', this)">Menu</button>
            <button onclick="showCustomerSection('cust-cart', this)">Cart</button>
            <button onclick="showCustomerSection('cust-reserve', this)">Reservations</button>
            <button onclick="showCustomerSection('cust-track', this)">Order Tracking</button>
        </div>

        <!-- MENU -->
        <div id="cust-menu" class="card">
            <div class="flex-row">
                <div class="flex-2">
                    <div class="small-label">Order Type</div>
                    <select id="custOrderType">
                        <option value="WALK_IN">Walk-in</option>
                        <option value="DINE_IN">Dine-in</option>
                        <option value="DELIVERY">Delivery</option>
                    </select>
                </div>
                <div class="flex-1" id="custTableWrapper" style="display:none;">
                    <div class="small-label">Table No</div>
                    <input id="custTableNo" type="number" min="1" placeholder="Table number">
                </div>
                <div class="flex-2" id="custAddressWrapper" style="display:none;">
                    <div class="small-label">Delivery Address</div>
                    <input id="custDeliveryAddress" type="text" placeholder="Building / Street / Flat">
                </div>
            </div>
            <div id="menuGrid" class="menu-grid"></div>
        </div>

        <!-- CART -->
        <div id="cust-cart" class="card" style="display:none;">
            <h3>Your Cart</h3>
            <div id="cartItems"></div>
            <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                <div><b>Total:</b> AED <span id="cartTotal">0</span></div>
                <button class="primary-btn" id="placeOrderBtn" onclick="placeOrder()" disabled>
                    Place Order
                </button>
            </div>
        </div>

        <!-- RESERVATIONS -->
        <div id="cust-reserve" class="card" style="display:none;">
            <h3>Table Reservations</h3>
            <div class="flex-row">
                <div class="flex-1">
                    <div class="small-label">Full Name</div>
                    <input id="resName" type="text" placeholder="Full Name">
                </div>
                <div class="flex-1">
                    <div class="small-label">Date</div>
                    <input id="resDate" type="date">
                </div>
                <div class="flex-1">
                    <div class="small-label">Time</div>
                    <input id="resTime" type="time">
                </div>
                <div class="flex-1">
                    <div class="small-label">Party Size</div>
                    <input id="resSize" type="number" min="1" placeholder="2">
                </div>
            </div>
            <div style="margin-top:10px;">
                <button class="primary-btn" onclick="submitReservation()">Confirm Reservation</button>
            </div>
            <div style="margin-top:16px;">
                <h4>Upcoming Reservations</h4>
                <div id="reservationList"></div>
            </div>
        </div>

        <!-- ORDER TRACKING -->
        <div id="cust-track" class="card" style="display:none;">
            <h3>Track Your Order</h3>
            <div class="flex-row">
                <div class="flex-1">
                    <div class="small-label">Order ID</div>
                    <input id="trackOrderId" type="number" placeholder="Enter Order ID">
                </div>
                <div class="flex-1" style="margin-top:18px;">
                    <button class="primary-btn" onclick="trackOrder()">Track</button>
                </div>
            </div>
            <div id="trackResult" style="margin-top:14px;"></div>
        </div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="panel-admin" class="panel">
        <h2>Admin Panel</h2>
        <p class="tagline">
            Manage menu prices, inventory levels, and monitor all orders and statuses.
        </p>
        <div class="subnav">
            <button class="active-sub" onclick="showAdminSection('adm-menu', this)">Menu Management</button>
            <button onclick="showAdminSection('adm-inv', this)">Inventory</button>
            <button onclick="showAdminSection('adm-orders', this)">Orders</button>
        </div>

        <!-- Menu Management -->
        <div id="adm-menu" class="card">
            <h3>Menu Items</h3>
            <div class="small-label">Edit prices and categories, then click Save.</div>
            <table id="adminMenuTable">
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Price (AED)</th><th>Category</th><th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Inventory -->
        <div id="adm-inv" class="card" style="display:none;">
            <h3>Inventory Management</h3>
            <div class="small-label">Update stock levels and low-stock thresholds.</div>
            <table id="adminInvTable">
                <thead>
                    <tr>
                        <th>ID</th><th>Item</th><th>Quantity</th><th>Unit</th><th>Low-Stock Level</th><th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Orders -->
        <div id="adm-orders" class="card" style="display:none;">
            <h3>All Orders</h3>
            <div id="adminOrders"></div>
        </div>
    </section>

    <!-- WAITER PANEL -->
    <section id="panel-waiter" class="panel">
        <h2>Waiter POS</h2>
        <p class="tagline">
            Create Dine-In / Delivery orders, send to kitchen, and mark as completed.
        </p>
        <div class="flex-row">
            <div class="card flex-1">
                <h3>New Order</h3>
                <div class="small-label">Order Type</div>
                <select id="waiterOrderType">
                    <option value="DINE_IN">Dine-in</option>
                    <option value="DELIVERY">Delivery</option>
                </select>
                <div class="small-label" id="waiterTableLabel">Table No</div>
                <input id="waiterTableNo" type="number" min="1" placeholder="Table number">

                <div id="waiterAddressWrapper" style="display:none;">
                    <div class="small-label">Delivery Address</div>
                    <input id="waiterAddress" type="text" placeholder="Address">
                </div>

                <div class="small-label" style="margin-top:8px;">Customer Name</div>
                <input id="waiterCustomerName" type="text" placeholder="e.g. Table 4 - John">

                <div class="small-label" style="margin-top:8px;">Add Items</div>
                <select id="waiterMenuSelect"></select>
                <input id="waiterQty" type="number" min="1" value="1" style="width:60px;">
                <button class="primary-btn" style="margin-top:6px;" onclick="waiterAddItem()">Add Item</button>

                <div id="waiterOrderItems" style="margin-top:10px;"></div>
                <div style="margin-top:10px;">
                    <button class="primary-btn" onclick="waiterSubmitOrder()">Submit Order</button>
                </div>
            </div>

            <div class="card flex-2">
                <h3>Active Orders</h3>
                <div id="waiterOrders"></div>
            </div>
        </div>
    </section>

    <!-- KITCHEN PANEL -->
    <section id="panel-kitchen" class="panel">
        <h2>Kitchen Display System (KDS)</h2>
        <p class="tagline">
            Chefs see the live queue, start preparation, and mark orders as READY.
        </p>
        <div class="card">
            <div class="small-label">Queue (RECEIVED / PREPARING)</div>
            <div id="kitchenQueue"></div>
        </div>
    </section>
</main>

<div id="toast" class="toast"></div>

<!-- Simple Login Modal -->
<div id="loginModal" style="
    position:fixed; inset:0; background:rgba(0,0,0,0.45);
    display:none; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:white; padding:16px 18px; border-radius:10px; width:280px;">
        <h3 style="margin-top:0;">Login</h3>
        <div class="small-label">Username</div>
        <input id="loginUser" type="text" placeholder="admin / waiter / chef" style="width:100%;">
        <div class="small-label" style="margin-top:6px;">Password</div>
        <input id="loginPass" type="password" placeholder="•••••••" style="width:100%;">
        <div style="margin-top:10px; display:flex; justify-content:space-between;">
            <button class="primary-btn" onclick="doLogin()">Login</button>
            <button class="danger-btn" onclick="toggleLogin()">Close</button>
        </div>
        <div id="loginMsg" style="margin-top:6px; font-size:12px; color:#d32f2f;"></div>
        <div style="margin-top:8px; font-size:11px; color:#555;">
            Demo accounts:<br>
            admin / admin123<br>
            waiter / waiter123<br>
            chef / chef123
        </div>
    </div>
</div>

<script>
const API_BASE = "http://127.0.0.1:5000";

let menuCache = [];
let cart = [];
let waiterDraftItems = [];
let currentRole = "customer";
let loggedRole = null;

// ---------- Toast ----------
function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2200);
}

// ---------- Role switching ----------
function switchRole(role, btn) {
    // ----- customer always allowed -----
    if (role === "customer") {
        currentRole = role;
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        document.getElementById("panel-customer").classList.add("active");

        document.querySelectorAll(".role-tabs button").forEach(b => b.classList.remove("active-role"));
        btn.classList.add("active-role");

        document.getElementById("userStatus").textContent =
            loggedRole ? "Logged in as: " + loggedRole : "Role: Customer (public)";
        return;
    }

    // ----- block admin without login -----
    if (role === "admin") {
        if (loggedRole !== "ADMIN") {
            showToast("Admin access requires login");
            toggleLogin();
            return;
        }
    }

    // ----- block waiter -----
    if (role === "waiter") {
        if (loggedRole !== "WAITER") {
            showToast("Waiter access requires login");
            toggleLogin();
            return;
        }
    }

    // ----- block chef -----
    if (role === "kitchen") {
        if (loggedRole !== "CHEF") {
            showToast("Chef access requires login");
            toggleLogin();
            return;
        }
    }

    // ----- now allowed -----
    currentRole = role;
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    document.getElementById("panel-" + role).classList.add("active");

    document.querySelectorAll(".role-tabs button").forEach(b => b.classList.remove("active-role"));
    btn.classList.add("active-role");

    document.getElementById("userStatus").textContent =
        "Logged in as: " + loggedRole;

    // load related data
    if (role === "admin") {
        loadAdminMenu();
        loadAdminInventory();
        loadAdminOrders();
    } else if (role === "waiter") {
        initWaiterMenuSelect();
        loadWaiterOrders();
    } else if (role === "kitchen") {
        loadKitchenQueue();
    }
}


// ---------- Login ----------
function toggleLogin() {
    const modal = document.getElementById("loginModal");
    modal.style.display = (modal.style.display === "flex") ? "none" : "flex";
}

async function doLogin() {
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";
    try {
        const res = await fetch(`${API_BASE}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p })
        });
        if (!res.ok) throw new Error("Invalid credentials");
        const data = await res.json();
        loggedRole = data.role;
        showToast(`Logged in as ${data.role}`);
        document.getElementById("userStatus").textContent = `Logged in as: ${data.role}`;
        toggleLogin();
    } catch (e) {
        msg.textContent = "Login failed. Check username/password.";
    }
}

// ---------- Health ----------
async function checkHealth() {
    const el = document.getElementById("healthStatus");
    try {
        const res = await fetch(`${API_BASE}/api/health`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        el.textContent = `Backend: ${data.status}`;
        el.style.background = "rgba(76, 175, 80, 0.25)";
    } catch {
        el.textContent = "Backend: offline";
        el.style.background = "rgba(229, 57, 53, 0.25)";
    }
}

// ---------- Customer sub-sections ----------
function showCustomerSection(id, btn) {
    ["cust-menu", "cust-cart", "cust-reserve", "cust-track"].forEach(sec => {
        document.getElementById(sec).style.display = (sec === id) ? "block" : "none";
    });
    document.querySelectorAll("#panel-customer .subnav button")
        .forEach(b => b.classList.remove("active-sub"));
    if (btn) btn.classList.add("active-sub");
}

// ---------- MENU ----------
async function loadMenu() {
    const grid = document.getElementById("menuGrid");
    grid.innerHTML = "<p>Loading menu...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/menu`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        menuCache = data.menu || [];

        grid.innerHTML = "";
        menuCache.forEach(item => {
            grid.innerHTML += `
                <div class="menu-card">
                    <img src="${item.img}" alt="${item.name}" />
                    <div class="menu-card-body">
                        <div class="menu-card-header">
                            <div><strong>${item.name}</strong></div>
                            <span class="badge">AED ${item.price}</span>
                        </div>
                        <p>${item.category || "Popular item"} · AI-ready</p>
                        <button onclick="addToCart(${item.id})">Add to Cart</button>
                    </div>
                </div>
            `;
        });
    } catch (e) {
        grid.innerHTML = "<p>Failed to load menu from backend.</p>";
    }
}

function addToCart(id) {
    const item = menuCache.find(m => m.id === id);
    if (!item) return;
    cart.push({ ...item, qty: 1 });
    renderCart();
    showToast(`${item.name} added to cart`);
}

function removeFromCart(i) {
    cart.splice(i, 1);
    renderCart();
}

function renderCart() {
    const list = document.getElementById("cartItems");
    const totalEl = document.getElementById("cartTotal");
    const btn = document.getElementById("placeOrderBtn");

    list.innerHTML = "";
    let total = 0;

    if (cart.length === 0) {
        list.innerHTML = "<p>Your cart is empty.</p>";
        totalEl.textContent = "0";
        btn.disabled = true;
        return;
    }

    cart.forEach((item, i) => {
        total += item.price * (item.qty || 1);
        list.innerHTML += `
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <div>
                    <div>${item.name}</div>
                    <small>AED ${item.price} x 
                        <input type="number" min="1" value="${item.qty || 1}"
                            style="width:50px;"
                            onchange="updateCartQty(${i}, this.value)">
                    </small>
                </div>
                <button class="danger-btn" onclick="removeFromCart(${i})">Remove</button>
            </div>
        `;
    });

    totalEl.textContent = total.toFixed(2);
    btn.disabled = false;
}

function updateCartQty(index, val) {
    const qty = Math.max(1, parseInt(val) || 1);
    cart[index].qty = qty;
    renderCart();
}

// ---------- Place Order ----------
async function placeOrder() {
    if (cart.length === 0) return;

    const orderType = document.getElementById("custOrderType").value;
    const tableNo = document.getElementById("custTableNo").value || null;
    const address = document.getElementById("custDeliveryAddress").value || null;

    if (orderType === "DINE_IN" && !tableNo) {
        showToast("Please enter table number for Dine-in");
        return;
    }
    if (orderType === "DELIVERY" && !address) {
        showToast("Please enter delivery address");
        return;
    }

    const btn = document.getElementById("placeOrderBtn");
    btn.disabled = true;
    btn.textContent = "Placing...";

    const payload = {
        customer_name: "Online Customer",
        order_type: orderType,
        table_no: tableNo ? Number(tableNo) : null,
        delivery_address: address,
        items: cart.map(c => ({
            id: c.id,
            name: c.name,
            price: c.price,
            qty: c.qty || 1
        }))
    };

    try {
        const res = await fetch(`${API_BASE}/api/orders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error();
        const data = await res.json();
        showToast(`Order #${data.id} placed (AED ${data.total.toFixed(2)})`);
        cart = [];
        renderCart();
        document.getElementById("trackOrderId").value = data.id;
        showCustomerSection("cust-track",
            document.querySelectorAll("#panel-customer .subnav button")[3]);
        trackOrder();
    } catch (e) {
        showToast("Failed to place order");
    } finally {
        btn.textContent = "Place Order";
        btn.disabled = cart.length === 0;
    }
}

// ---------- Order Type UI ----------
document.getElementById("custOrderType").addEventListener("change", () => {
    const type = document.getElementById("custOrderType").value;
    document.getElementById("custTableWrapper").style.display =
        (type === "DINE_IN") ? "block" : "none";
    document.getElementById("custAddressWrapper").style.display =
        (type === "DELIVERY") ? "block" : "none";
});

// ---------- Reservations ----------
async function submitReservation() {
    const name = document.getElementById("resName").value.trim();
    const date = document.getElementById("resDate").value;
    const time = document.getElementById("resTime").value;
    const size = document.getElementById("resSize").value;

    if (!name || !date || !time || !size) {
        showToast("Fill all reservation fields");
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/api/reservations`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, date, time, size: Number(size) })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast("Reservation saved");
        document.getElementById("resName").value = "";
        document.getElementById("resDate").value = "";
        document.getElementById("resTime").value = "";
        document.getElementById("resSize").value = "";
        loadReservations();
    } catch (e) {
        showToast("Failed to save reservation");
    }
}

async function loadReservations() {
    const list = document.getElementById("reservationList");
    list.innerHTML = "<p>Loading...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/reservations`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const reservations = data.reservations || [];

        if (reservations.length === 0) {
            list.innerHTML = "<p>No reservations yet.</p>";
            return;
        }

        list.innerHTML = "";
        reservations.forEach(r => {
            list.innerHTML += `
                <div style="margin-bottom:6px; padding:6px 8px; border-radius:8px; background:#fafafa;">
                    <b>${r.name}</b><br>
                    ${r.date} at ${r.time} · Party of ${r.size}
                </div>
            `;
        });
    } catch {
        list.innerHTML = "<p>Failed to load reservations.</p>";
    }
}

// ---------- Order Tracking ----------
async function trackOrder() {
    const id = document.getElementById("trackOrderId").value.trim();
    const box = document.getElementById("trackResult");
    if (!id) {
        box.innerHTML = "<p>Please enter an order ID.</p>";
        return;
    }
    box.innerHTML = "<p>Loading...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/orders/${id}`);
        if (!res.ok) throw new Error();
        const o = await res.json();

        const steps = ["RECEIVED", "PREPARING", "READY", "OUT_FOR_DELIVERY", "COMPLETED"];
        let html = `
            <p><b>Order #${o.id}</b> (${o.order_type})<br>
               Status: <span class="status-pill status-${o.status}">${o.status}</span></p>
            <p><b>Timeline:</b></p>
            <ul>
        `;
        (o.log || []).forEach(entry => {
            html += `<li>${entry.timestamp} — ${entry.status}</li>`;
        });
        html += "</ul>";

        html += "<p><b>Items:</b></p><ul>";
        (o.items || []).forEach(it => {
            html += `<li>${it.name} x ${it.qty} (AED ${it.price})</li>`;
        });
        html += "</ul>";

        box.innerHTML = html;
    } catch (e) {
        box.innerHTML = "<p>Order not found.</p>";
    }
}

// ---------- Admin: Menu ----------
async function loadAdminMenu() {
    const tbody = document.querySelector("#adminMenuTable tbody");
    tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    try {
        const res = await fetch(`${API_BASE}/api/menu`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const menu = data.menu || [];
        tbody.innerHTML = "";
        menu.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td><input id="m-name-${item.id}" value="${item.name}"></td>
                    <td><input id="m-price-${item.id}" type="number" step="0.1" value="${item.price}"></td>
                    <td><input id="m-cat-${item.id}" value="${item.category || ""}"></td>
                    <td><button class="primary-btn" onclick="saveMenuItem(${item.id})">Save</button></td>
                </tr>
            `;
        });
    } catch {
        tbody.innerHTML = "<tr><td colspan='5'>Failed to load menu.</td></tr>";
    }
}

async function saveMenuItem(id) {
    const name = document.getElementById(`m-name-${id}`).value;
    const price = document.getElementById(`m-price-${id}`).value;
    const cat = document.getElementById(`m-cat-${id}`).value;
    try {
        const res = await fetch(`${API_BASE}/api/menu/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, price, category: cat })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast("Menu item saved");
        loadMenu(); // refresh customer view
    } catch {
        showToast("Failed to save menu item");
    }
}

// ---------- Admin: Inventory ----------
async function loadAdminInventory() {
    const tbody = document.querySelector("#adminInvTable tbody");
    tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
    try {
        const res = await fetch(`${API_BASE}/api/inventory`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const inv = data.inventory || [];
        tbody.innerHTML = "";
        inv.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td><input id="inv-q-${item.id}" type="number" step="0.1" value="${item.quantity}"></td>
                    <td>${item.unit}</td>
                    <td><input id="inv-low-${item.id}" type="number" step="0.1" value="${item.low_stock_threshold}"></td>
                    <td><button class="primary-btn" onclick="saveInventoryItem(${item.id})">Save</button></td>
                </tr>
            `;
        });
    } catch {
        tbody.innerHTML = "<tr><td colspan='6'>Failed to load inventory.</td></tr>";
    }
}

async function saveInventoryItem(id) {
    const q = document.getElementById(`inv-q-${id}`).value;
    const low = document.getElementById(`inv-low-${id}`).value;
    try {
        const res = await fetch(`${API_BASE}/api/inventory/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quantity: q, low_stock_threshold: low })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast("Inventory updated");
    } catch {
        showToast("Failed to update inventory");
    }
}

// ---------- Admin: Orders ----------
async function loadAdminOrders() {
    const box = document.getElementById("adminOrders");
    box.innerHTML = "<p>Loading...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/orders`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const orders = data.orders || [];
        if (orders.length === 0) {
            box.innerHTML = "<p>No orders yet.</p>";
            return;
        }
        let html = "";
        orders.forEach(o => {
            let itemsHtml = "<ul>";
            (o.items || []).forEach(it => {
                itemsHtml += `<li>${it.name} x ${it.qty} (AED ${it.price})</li>`;
            });
            itemsHtml += "</ul>";
            html += `
                <div class="card" style="margin-bottom:10px; padding:10px 12px;">
                    <b>Order #${o.id}</b> — ${o.customer_name} (${o.order_type})<br>
                    Created: ${o.created_at}<br>
                    ${o.table_no ? "Table: " + o.table_no + "<br>" : ""}
                    ${o.delivery_address ? "Address: " + o.delivery_address + "<br>" : ""}
                    Status:
                    <select onchange="adminChangeStatus(${o.id}, this.value)">
                        ${["RECEIVED","PREPARING","READY","OUT_FOR_DELIVERY","COMPLETED","CANCELLED"]
                            .map(s => `<option value="${s}" ${s===o.status?"selected":""}>${s}</option>`).join("")}
                    </select>
                    <br>
                    <b>Total:</b> AED ${o.total.toFixed(2)}
                    <br>
                    ${itemsHtml}
                </div>
            `;
        });
        box.innerHTML = html;
    } catch {
        box.innerHTML = "<p>Failed to load orders.</p>";
    }
}

async function adminChangeStatus(id, status) {
    try {
        const res = await fetch(`${API_BASE}/api/orders/${id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast("Status updated");
        loadAdminOrders();
    } catch {
        showToast("Failed to update status");
    }
}

// ---------- Admin subnav ----------
function showAdminSection(id, btn) {
    ["adm-menu","adm-inv","adm-orders"].forEach(sec => {
        document.getElementById(sec).style.display = (sec === id) ? "block" : "none";
    });
    document.querySelectorAll("#panel-admin .subnav button")
        .forEach(b => b.classList.remove("active-sub"));
    if (btn) btn.classList.add("active-sub");
}

// ---------- Waiter ----------
function initWaiterMenuSelect() {
    const sel = document.getElementById("waiterMenuSelect");
    sel.innerHTML = "";
    menuCache.forEach(m => {
        sel.innerHTML += `<option value="${m.id}">${m.name} (AED ${m.price})</option>`;
    });
}

document.getElementById("waiterOrderType").addEventListener("change", () => {
    const type = document.getElementById("waiterOrderType").value;
    document.getElementById("waiterTableLabel").style.display =
        (type === "DINE_IN") ? "block" : "none";
    document.getElementById("waiterTableNo").style.display =
        (type === "DINE_IN") ? "block" : "none";
    document.getElementById("waiterAddressWrapper").style.display =
        (type === "DELIVERY") ? "block" : "none";
});

function waiterAddItem() {
    const id = Number(document.getElementById("waiterMenuSelect").value);
    const qty = Math.max(1, parseInt(document.getElementById("waiterQty").value) || 1);
    const item = menuCache.find(m => m.id === id);
    if (!item) return;
    waiterDraftItems.push({ ...item, qty });
    renderWaiterDraft();
}

function renderWaiterDraft() {
    const box = document.getElementById("waiterOrderItems");
    if (waiterDraftItems.length === 0) {
        box.innerHTML = "<p>No items yet.</p>";
        return;
    }
    let html = "<ul>";
    waiterDraftItems.forEach((it, i) => {
        html += `<li>${it.name} x ${it.qty} (AED ${it.price}) 
                 <button class="danger-btn" onclick="waiterRemoveItem(${i})">X</button></li>`;
    });
    html += "</ul>";
    box.innerHTML = html;
}

function waiterRemoveItem(i) {
    waiterDraftItems.splice(i,1);
    renderWaiterDraft();
}

async function waiterSubmitOrder() {
    if (waiterDraftItems.length === 0) {
        showToast("Add items first");
        return;
    }
    const type = document.getElementById("waiterOrderType").value;
    const tableNo = document.getElementById("waiterTableNo").value;
    const address = document.getElementById("waiterAddress").value;
    const customerName = document.getElementById("waiterCustomerName").value || "Walk-in";

    if (type === "DINE_IN" && !tableNo) {
        showToast("Enter table number");
        return;
    }
    if (type === "DELIVERY" && !address) {
        showToast("Enter delivery address");
        return;
    }

    const payload = {
        customer_name: customerName,
        order_type: type,
        table_no: type === "DINE_IN" ? Number(tableNo) : null,
        delivery_address: type === "DELIVERY" ? address : null,
        items: waiterDraftItems.map(i => ({
            id: i.id,
            name: i.name,
            price: i.price,
            qty: i.qty
        }))
    };

    try {
        const res = await fetch(`${API_BASE}/api/orders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error();
        const data = await res.json();
        showToast(`Waiter order #${data.id} created`);
        waiterDraftItems = [];
        renderWaiterDraft();
        loadWaiterOrders();
    } catch {
        showToast("Failed to create order");
    }
}

async function loadWaiterOrders() {
    const box = document.getElementById("waiterOrders");
    box.innerHTML = "<p>Loading...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/orders`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const orders = data.orders || [];
        if (orders.length === 0) {
            box.innerHTML = "<p>No orders yet.</p>";
            return;
        }
        let html = "";
        orders.forEach(o => {
            let itemsHtml = "<ul>";
            (o.items || []).forEach(it => {
                itemsHtml += `<li>${it.name} x ${it.qty}</li>`;
            });
            itemsHtml += "</ul>";

            html += `
                <div style="margin-bottom:8px; padding:6px 8px; border-radius:10px; background:#fafafa;">
                    <b>#${o.id}</b> (${o.order_type}) 
                    ${o.table_no ? "· Table " + o.table_no : ""} 
                    <br>Status: <span class="status-pill status-${o.status}">${o.status}</span>
                    <br>Total AED ${o.total.toFixed(2)}
                    ${itemsHtml}
                    <button class="primary-btn" style="margin-right:4px;"
                        onclick="waiterAdvanceStatus(${o.id}, '${o.status}')">
                        Advance Status
                    </button>
                </div>
            `;
        });
        box.innerHTML = html;
    } catch {
        box.innerHTML = "<p>Failed to load orders.</p>";
    }
}

async function waiterAdvanceStatus(id, currentStatus) {
    const flow = ["RECEIVED","PREPARING","READY","COMPLETED"];
    const idx = flow.indexOf(currentStatus);
    const next = idx >= 0 && idx < flow.length - 1 ? flow[idx + 1] : "COMPLETED";

    try {
        const res = await fetch(`${API_BASE}/api/orders/${id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: next })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast(`Order #${id} → ${next}`);
        loadWaiterOrders();
    } catch {
        showToast("Failed to update order");
    }
}

// ---------- Kitchen ----------
async function loadKitchenQueue() {
    const box = document.getElementById("kitchenQueue");
    box.innerHTML = "<p>Loading...</p>";
    try {
        const res = await fetch(`${API_BASE}/api/orders?for=kitchen=1&for=kitchen`);
        // note: query is ?for=kitchen, simple
    } catch (e) {
        // older browsers might not like above
    }
    try {
        const res = await fetch(`${API_BASE}/api/orders?for=kitchen`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        const orders = data.orders || [];
        if (orders.length === 0) {
            box.innerHTML = "<p>No active kitchen orders.</p>";
            return;
        }
        let html = "";
        orders.forEach(o => {
            let itemsHtml = "<ul>";
            (o.items || []).forEach(it => {
                itemsHtml += `<li>${it.name} x ${it.qty}</li>`;
            });
            itemsHtml += "</ul>";
            html += `
                <div style="margin-bottom:8px; padding:8px 10px; border-radius:10px; background:#fff3cd;">
                    <b>Order #${o.id}</b> (${o.order_type}) 
                    ${o.table_no ? "· Table " + o.table_no : ""}<br>
                    Status: <span class="status-pill status-${o.status}">${o.status}</span><br>
                    ${itemsHtml}
                    <button class="primary-btn" style="margin-right:4px;"
                        onclick="kitchenSetStatus(${o.id}, 'PREPARING')">Start</button>
                    <button class="primary-btn"
                        onclick="kitchenSetStatus(${o.id}, 'READY')">Mark Ready</button>
                </div>
            `;
        });
        box.innerHTML = html;
    } catch {
        box.innerHTML = "<p>Failed to load kitchen queue.</p>";
    }
}

async function kitchenSetStatus(id, status) {
    try {
        const res = await fetch(`${API_BASE}/api/orders/${id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
        });
        if (!res.ok) throw new Error();
        await res.json();
        showToast(`Kitchen set #${id} → ${status}`);
        loadKitchenQueue();
    } catch {
        showToast("Failed to update order");
    }
}

// ---------- INIT ----------
window.addEventListener("load", () => {
    checkHealth();
    loadMenu();
    loadReservations();
    renderCart();
    setInterval(() => {
        if (currentRole === "kitchen") loadKitchenQueue();
        if (currentRole === "waiter") loadWaiterOrders();
        if (currentRole === "admin") {
            loadAdminOrders();
        }
    }, 5000);
});
</script>

</body>
</html>
